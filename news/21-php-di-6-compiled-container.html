<!DOCTYPE html>
<!--[if lt IE 7]>
<html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>
<html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>
<html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>PHP-DI 6: turning into a compiled container for maximum performances - The Dependency Injection Container for humans</title>
    <meta name="description" content="PHP-DI is a Dependency Injection Container for PHP that intends to be practical and powerful.">

    <link rel="canonical" href="http://php-di.org" />

    <meta name="application-name" content="PHP-DI"/>
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://php-di.org/img/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="http://php-di.org/img/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="http://php-di.org/img/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="http://php-di.org/img/favicon-16x16.png" sizes="16x16" />
    <meta name="msapplication-TileColor" content="#484949" />
    <meta name="msapplication-TileImage" content="http://php-di.org/img/mstile-144x144.png" />

            <link href="http://fonts.googleapis.com/css?family=Abel:400|Oswald:300,400,700" media="all" rel="stylesheet" type="text/css">
        <link href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css" rel="stylesheet">
        <link href="http://php-di.org/css/highlight.github.css" rel="stylesheet">
        <link href="http://php-di.org/css/all.min.css" rel="stylesheet">
    </head>
<body>

    <header>
        <div class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#top-navigation">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="http://php-di.org/" title="Dependency injection container for PHP">PHP-DI</a>
                </div>
                <div class="navbar-form navbar-left hidden-xs hidden-sm">
                    <input id="search-input" type="text" class="form-control" placeholder="Search...">
                </div>
                <div class="collapse navbar-collapse" id="top-navigation">
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="http://php-di.org/doc/getting-started.html" title="Getting started with PHP-DI">Getting started</a></li>
                        <li><a href="http://php-di.org/doc/" title="PHP-DI documentation">Documentation</a></li>
                        <li><a href="http://php-di.org/support.html" title="Enterprise support for PHP-DI">For Enterprise</a></li>
                        <li><a href="http://php-di.org/news/" title="News about PHP-DI">News</a></li>
                        <li><a href="http://php-di.org/change-log.html" title="PHP-DI's changelog">Changelog</a></li>
                        <li><a class="github" href="https://github.com/PHP-DI/PHP-DI" title="PHP-DI on GitHub"><i class="fa fa-github"></i></a></li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    
    <section class="container">
        <div class="row">
            <div class="col-md-9">

                
    <article>
        <h1>PHP-DI 6: turning into a compiled container for maximum performances</h1>

        <p class="article-information">
            Posted by Matthieu Napoli on January 24th, 2018
        </p>

        <p>PHP-DI's motto is &quot;The dependency injection container for humans&quot;.</p>
<p>This is very important because it defines what PHP-DI tries to be: practical to use, consistent, predictable, with a configuration format that is easy to read and write and a great documentation.</p>
<p>It also defines what PHP-DI does not try to be, and that is as much important. PHP-DI does not try to be the smallest, or the fastest container out there. And PHP-DI 5 is by far not one of the fastest containers.</p>
<p>But the good thing is that, after 6 years of existence, the project has matured and is now quite stable. The original objectives are met, even though there is of course always room for improvements and innovation. There is room to push the container to be better on other levels. And the most obvious one is <strong>performances</strong>.</p>
<p>PHP-DI 6 will be much, much faster because it is a compiled container.</p>
<h2 id="what-does-quotcompilingquot-mean">What does &quot;compiling&quot; mean?</h2>
<p>Imagine the following class:</p>
<pre><code class="language-php">class Foo
{
    public function __construct(Bar $bar) { â€¦ }
}</code></pre>
<p>And the following configuration file:</p>
<pre><code class="language-php">return [

    Foo::class =&gt; create()
        -&gt;constructor(get(Bar::class)),

    // Let's use a closure just for the sake of the example
    Bar::class =&gt; function() {
        return new Bar('Hello world');
    },

];</code></pre>
<p>If we were to implement this without any containers, here is how we would instantiate <code>Foo</code> and <code>Bar</code>:</p>
<pre><code class="language-php">$bar = new Bar('Hello world');
$foo = new Foo($bar);</code></pre>
<p>In a container, things go differently because the container is generic: it can handle 0 or many parameters, with references to a lot of entries, etc. To do that, the container constructs <em>definition objects</em>. A definition explains <em>how</em> to create an instance. More concretely, it is a class that stores the number of parameters of the constructor, which parameters need to be injected, etc.</p>
<p>If you are curious, you can read <a href="https://github.com/PHP-DI/PHP-DI/blob/b6ff39dd7eb3a67485af7992274367acc2d04b6e/src/Definition/Resolver/ObjectCreator.php#L114-L162">PHP-DI's <code>ObjectCreator</code> class</a>: it takes a definition object and creates an object.</p>
<p>This process involves using PHP's Reflection API and a lot of logic (especially if the container is quite smart). And of course, this takes time. This is actually where PHP-DI spends most of its time. This is also the reason why &quot;simple&quot; containers like Pimple are faster than more complex ones: they have very simple (and limited) logic for creating objects.</p>
<p><strong>Compiling the container means bypassing all that</strong>. The idea is to take all the definitions and turn them into optimized PHP code, close to the code we would write ourselves (except we don't have to write it ourselves).</p>
<p>Here is an theoretical example of a compiled container (not actual PHP-DI generated code):</p>
<pre><code class="language-php">// The class has a random number in there because it's auto-generated
class CompiledContainer123456 extends BaseCompiledContainer
{
    public function get($id)
    {
        // Method implemented in the parent class.
        // Basically it calls `$this-&gt;create{$id}()`
    }

    protected function createFoo()
    {
        return new Foo($this-&gt;get('bar'));
    }

    protected function createBar()
    {
        return new Bar('Hello world');
    }
}</code></pre>
<p>Compiling the container means generating that class. Instead of manipulating definitions, the compiled container simply calls code that is optimized for your objects and your project.</p>
<h3 id="compiling-closures">Compiling closures</h3>
<p>PHP-DI is not the first compiled container. <a href="https://symfony.com/doc/current/components/dependency_injection.html">Symfony's approach</a> was a huge inspiration on how to tackle this problem.</p>
<p>However one thing specific to PHP-DI 6 is that even closures are compiled. For example:</p>
<pre><code class="language-php">return [
    Foo::class =&gt; function() {
        return new Foo();
    },
];</code></pre>
<p>The <code>Foo</code> entry will be compiled and will benefit from the performance improvements. This will work even if the closure takes parameters, uses type-hinting, etc. This is made possible thanks to the awesome <a href="https://github.com/jeremeamia/super_closure">SuperClosure</a> and <a href="https://github.com/nikic/PHP-Parser">PHP-Parser</a> projects. The only other container that I know of that can compile closures is <a href="https://github.com/thecodingmachine/yaco">Yaco</a>.</p>
<h3 id="usage">Usage</h3>
<p>Compiling the container is very simple, you simply have to call <code>enableCompilation()</code>:</p>
<pre><code class="language-php">$containerBuilder = new \DI\ContainerBuilder();

$containerBuilder-&gt;addDefinitions([
    Foo::class =&gt; create()
]);

$containerBuilder-&gt;enableCompilation(__DIR__ . '/var/cache');
$container = $containerBuilder-&gt;build();</code></pre>
<p>The first time this code is run, the container will be compiled into a PHP file in the <code>var/cache</code> directory. On all future executions the compiled container will be used directly.</p>
<p>Integrating that with your deployment script should be easy too: simply clear the directory on every deploy and PHP-DI will recompile the container. You can also pre-generate the container in advance in your deploy script, just run the code above once.</p>
<h2 id="performances">Performances</h2>
<h3 id="externalsio">Externals.io</h3>
<p>Here is a comparison running PHP-DI 6 on <a href="https://externals.io">externals.io</a> (measuring the load time of the home page):</p>
<ul>
<li>with cache enabled: 37ms</li>
<li>with cache <strong>and compilation</strong> enabled: 28ms</li>
</ul>
<p>That means a <strong>23% improvement in the total loading time</strong>, and 6% less memory used.</p>
<p><a href="https://blackfire.io/profiles/compare/68d775b5-39bb-4cd8-87b3-51b75a297377/graph"><img src="https://i.imgur.com/O1Wddn6.png" alt="" /></a></p>
<p>(<a href="https://blackfire.io/profiles/compare/68d775b5-39bb-4cd8-87b3-51b75a297377/graph">Blackfire comparison</a>)</p>
<p>Of course in a more complex application the time spent in the container will be lower so the gains will probably be lower.</p>
<p>On a side note, we can also compare v6 with v5 (<a href="https://blackfire.io/profiles/compare/3b8775f6-35e9-458f-882b-31ede384ab28/graph">Blackfire profile</a>):</p>
<ul>
<li>PHP-DI 5 with cache: 42ms</li>
<li>PHP-DI 6 with cache: 37ms</li>
</ul>
<p>Even without compilation, <a href="https://externals.io">externals.io</a> runs 12% faster on v6 than on v5. This is thanks to many optimizations added during the development of version 6.</p>
<p>In total, with compilation enabled, <strong>migrating from PHP-DI 5 to PHP-DI 6 gives <a href="https://blackfire.io/profiles/compare/647ec5b4-08f4-4a82-821f-f1ef7be9cad8/graph">a 32% performance improvement</a> on externals.io</strong>.</p>
<p><a href="https://blackfire.io/profiles/compare/647ec5b4-08f4-4a82-821f-f1ef7be9cad8/graph"><img src="https://i.imgur.com/AdIVPuL.png" alt="" /></a></p>
<h3 id="di-container-benchmark">DI container benchmark</h3>
<p>The gains shown above can also be seen in the <a href="https://github.com/kocsismate/php-di-container-benchmarks">kocsismate di-container-benchmarks</a>.
Here is a comparison of the results for PHP-DI 5 and PHP-DI 6. The left column is v5, the right is v6, and higher in the list is better:</p>
<ul>
<li>Test suite 1</li>
</ul>
<div class="row">
    <div class="col-sm-6"><img src="https://i.imgur.com/xPSb2Sd.png"></div>
    <div class="col-sm-6"><img src="https://i.imgur.com/HAm4cQS.png"></div>
</div>
<ul>
<li>Test suite 2</li>
</ul>
<div class="row">
    <div class="col-sm-6"><img src="https://i.imgur.com/W20UJMT.png"></div>
    <div class="col-sm-6"><img src="https://i.imgur.com/Ekj5WgC.png"></div>
</div>
<ul>
<li>Test suite 5</li>
</ul>
<div class="row">
    <div class="col-sm-6"><img src="https://i.imgur.com/5l6Xn87.png"></div>
    <div class="col-sm-6"><img src="https://i.imgur.com/b1vls8Y.png"></div>
</div>
<ul>
<li>Test suite 6</li>
</ul>
<div class="row">
    <div class="col-sm-6"><img src="https://i.imgur.com/gxN7lJT.png"></div>
    <div class="col-sm-6"><img src="https://i.imgur.com/evEQGHh.png"></div>
</div>
<p>PHP-DI now ranks in the fastest containers. Needless to say I am very happy with the results, especially since it is one of the most feature-rich containers.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Compiling the container brings massive performance improvements for the container and finally makes PHP-DI one of the fastest DI containers out there.</p>
<p>Let's keep in mind however that DI containers usually represents a small part of most application's run time. While I'm very happy to report all these improvements, do not expect your application to run twice faster in production ;)</p>
<p>Want to try this out? PHP-DI 6.0 will be released in the next weeks, in the meantime give the latest beta a try: <a href="https://github.com/PHP-DI/PHP-DI/releases">https://github.com/PHP-DI/PHP-DI/releases</a></p>
    </article>

    <h3>
        Comments
    </h3>
    <div id="disqus_thread"></div>
    <noscript>
        Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>


            </div>

            <div class="col-md-3">
                <h3>
                    All posts
                </h3>

                <ul class="all-posts list-unstyled">
                    <li>
                        <a href="http://php-di.org/news/22-php-di-6-0-released.html">PHP-DI 6.0 released</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/21-php-di-6-compiled-container.html">PHP-DI 6: turning into a compiled container for maximum performances</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/20-php-di-5-4-released.html">PHP-DI 5.4 released</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/19-php-di-5-3-released.html">PHP-DI 5.3 released</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/18-slim-bridge-released.html">Introducing the PHP-DI bridge for Slim</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/17-php-di-5-2-released.html">PHP-DI 5.2 released</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/16-php-di-5-1-released.html">PHP-DI 5.1 released</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/15-php-di-5-0-released.html">PHP-DI 5.0 released</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/14-php-di-5-syntaxic-sugar.html">Syntactic sugar in PHP-DI 5</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/13-php-di-4-4-released.html">PHP-DI 4.4 released</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/12-php-di-is-better-with-php-5-6.html">PHP 5.6 is out and PHP-DI just got better</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/11-php-di-4-3-released.html">PHP-DI 4.3 released</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/10-php-di-4-2-released.html">PHP-DI 4.2 released</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/09-php-di-4-1-released.html">PHP-DI 4.1 released</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/08-10000-installs.html">10.000 installs!</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/07-php-di-4-0-released.html">PHP-DI 4.0 released</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/06-php-di-4-0-new-definitions.html">What will change in PHP-DI 4: the new definition format</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/05-php-di-3-5.html">PHP-DI 3.5 released</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/04-php-di-3-4.html">PHP-DI 3.4 released</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/03-php-di-3-3.html">PHP-DI 3.3 released</a>
                    </li>
                    <li>
                        <a href="http://php-di.org/news/02-php-di-3-2.html">PHP-DI 3.2 released</a>
                    </li>
                </ul>
            </div>

        </div>
    </section>


            <footer>
            <div class='container'>
                                    <p>
                        A question? Unsatisfied with the documentation?
                        Please <a href="https://github.com/PHP-DI/PHP-DI/issues/new">create an issue</a>
                        or chat on
                        <a href="https://gitter.im/PHP-DI/PHP-DI" title="PHP-DI chat room">Gitter</a> or
                        <a href="https://twitter.com/phpdi" title="PHP-DI on Twitter">Twitter</a>.
                    </p>
                                <p>
                    <a href="https://twitter.com/share" class="twitter-share-button" data-related="PHPDI" data-dnt="true">Tweet</a>
                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                </p>
                <p>
                    By <a href="http://mnapoli.fr/" title="Software consulting and PHP news">Matthieu Napoli</a>
                    and <a href="https://github.com/PHP-DI/PHP-DI/graphs/contributors" title="PHP-DI contributors">contributors</a>
                    |
                    Website generated with
                    <a href="http://couscous.io" title="Static website generator for software documentation">Couscous</a>,
                    supported by <a href="https://prettyci.com/" title="Continuous integration for PHP coding standards">PrettyCI.com</a>.
                </p>
            </div>
        </footer>
    
                <script src="http://php-di.org/bower_components/jquery/dist/jquery.min.js"></script>
        <script src="http://php-di.org/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>

        <script>
            $(function() {
                hljs.initHighlightingOnLoad();

                // Add anchors to headers
                $('article h2, article h3, article h4, article h5').each(function () {
                    var url = document.URL.replace(/#.*$/, "") + '#' + $(this).attr('id');
                    $(this).append(' <a class="anchor" href="' + url + '">#</a>');
                });
            });
        </script>
    

    <script>
        // Disqus comments
        var disqus_shortname = 'phpdi';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>

    <script>
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-15584647-13']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    <!-- Gitter -->
    <script>
        ((window.gitter = {}).chat = {}).options = {
            room: 'PHP-DI/PHP-DI'
        };
    </script>
    <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <script type="text/javascript">
        $(function () {
            var search = docsearch({
                apiKey: 'ef6af24cbacae1f85d3c44741df49167',
                indexName: 'php-di',
                inputSelector: '#search-input'
            });
            var delay = (function () {
                var timer = 0;
                return function (callback, ms) {
                    clearTimeout(timer);
                    timer = setTimeout(callback, ms);
                };
            })();
            search.autocomplete.on('autocomplete:selected', function (e, suggestion) {
                var articleTitle = suggestion.subcategory;
                // Strip HTML tags
                var div = document.createElement("div");
                div.innerHTML = articleTitle;
                articleTitle = div.textContent || div.innerText || "";
                _gaq.push(['_trackEvent', 'search', 'click', articleTitle]);
            });
            $('#search-input').bind('input', function () {
                var search = $(this).val();
                if (search.length < 3) {
                    return;
                }
                delay(function () {
                    _gaq.push(['_trackPageview', '/search?q=' + search]);
                }, 600);
            });
        });
    </script>

</body>
</html>
